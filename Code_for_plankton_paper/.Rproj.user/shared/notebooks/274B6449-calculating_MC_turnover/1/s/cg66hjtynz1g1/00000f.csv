"0","# Corrected Monte Carlo Function with Safe C_exp Sampling and Plotting Sanity Checks"
"0",""
"0","monte_carlo_TT <- function("
"0","  SS_small, SS_large,"
"0","  C_exp_small, C_exp_large,"
"0","  C_uncertainty_fraction, SS_uncertainty_fraction,"
"0","  Vs_low_small, Vs_high_small, Vs_low_large, Vs_high_large,"
"0","  n_simulations = 100000, confidence_level = 0.95"
"0",") {"
"0",""
"0","  # Stop if C_exp is missing"
"0","  if (is.na(C_exp_small) || is.na(C_exp_large)) {"
"0","    stop(""Error: C_exp values contain NA. Please check input data."")"
"0","  }"
"0",""
"0","  # Compute absolute uncertainty from fraction for C_exp"
"0","  C_uncertainty_small <- C_uncertainty_fraction * C_exp_small"
"0","  C_uncertainty_large <- C_uncertainty_fraction * C_exp_large"
"0",""
"0","  # Sample C_exp, ensure non-negative values using pmax"
"0","  C_samples_small <- if (C_uncertainty_small > 0) {"
"0","    pmax(rnorm(n_simulations, mean = C_exp_small, sd = C_uncertainty_small), 0)"
"0","  } else {"
"0","    rep(C_exp_small, n_simulations)"
"0","  }"
"0",""
"0","  C_samples_large <- if (C_uncertainty_large > 0) {"
"0","    pmax(rnorm(n_simulations, mean = C_exp_large, sd = C_uncertainty_large), 0)"
"0","  } else {"
"0","    rep(C_exp_large, n_simulations)"
"0","  }"
"0",""
"0","  # Compute absolute uncertainty for SS"
"0","  SS_uncertainty_small <- SS_uncertainty_fraction * SS_small"
"0","  SS_uncertainty_large <- SS_uncertainty_fraction * SS_large"
"0",""
"0","  # Sample SS with rnorm"
"0","  SS_samples_small <- if (SS_uncertainty_small > 0) {"
"0","    pmax(rnorm(n_simulations, mean = SS_small, sd = SS_uncertainty_small), 0)"
"0","  } else {"
"0","    rep(SS_small, n_simulations)"
"0","  }"
"0",""
"0","  SS_samples_large <- if (SS_uncertainty_large > 0) {"
"0","    pmax(rnorm(n_simulations, mean = SS_large, sd = SS_uncertainty_large), 0)"
"0","  } else {"
"0","    rep(SS_large, n_simulations)"
"0","  }"
"0",""
"0","  # Sample Vs from uniform distribution"
"0","  Vs_samples_small <- runif(n_simulations, min = Vs_low_small, max = Vs_high_small)"
"0","  Vs_samples_large <- runif(n_simulations, min = Vs_low_large, max = Vs_high_large)"
"0",""
"0","  # Compute F_exp = C_exp * Vs"
"0","  F_exp_samples_small <- C_samples_small * Vs_samples_small"
"0","  F_exp_samples_large <- C_samples_large * Vs_samples_large"
"0",""
"0","  # Compute turnover time TT = SS / F_exp"
"0","  TT_samples_small <- SS_samples_small / F_exp_samples_small"
"0","  TT_samples_large <- SS_samples_large / F_exp_samples_large"
"0",""
"0","  # Clean samples: remove NaN, Inf, negative, or zero"
"0","  TT_samples_small <- TT_samples_small[is.finite(TT_samples_small) & TT_samples_small > 0]"
"0","  TT_samples_large <- TT_samples_large[is.finite(TT_samples_large) & TT_samples_large > 0]"
"0",""
"0","  # Compute mean and standard deviation"
"0","  mean_TT_small <- mean(TT_samples_small)"
"0","  std_TT_small <- sd(TT_samples_small)"
"0","  mean_TT_large <- mean(TT_samples_large)"
"0","  std_TT_large <- sd(TT_samples_large)"
"0",""
"0","  # Confidence intervals for small stage"
"0","  z_s <- qnorm(1 - (1 - confidence_level) / 2)"
"0","  error_s <- z_s * (std_TT_small / sqrt(length(TT_samples_small)))"
"0","  ci_lower_s <- mean_TT_small - error_s"
"0","  ci_upper_s <- mean_TT_small + error_s"
"0",""
"0","  # Confidence intervals for large stage"
"0","  z_l <- qnorm(1 - (1 - confidence_level) / 2)"
"0","  error_l <- z_l * (std_TT_large / sqrt(length(TT_samples_large)))"
"0","  ci_lower_l <- mean_TT_large - error_l"
"0","  ci_upper_l <- mean_TT_large + error_l"
"0",""
"0","  # Return results as data frame"
"0","  return(list("
"0","    TT_samples_small = TT_samples_small,"
"0","    mean_TT_small = mean_TT_small,"
"0","    std_TT_small = std_TT_small,"
"0","    ci_lower_s = ci_lower_s,"
"0","    ci_upper_s = ci_upper_s,"
"0","    TT_samples_large = TT_samples_large,"
"0","    mean_TT_large = mean_TT_large,"
"0","    std_TT_large = std_TT_large,"
"0","    ci_lower_l = ci_lower_l,"
"0","    ci_upper_l = ci_upper_l"
"0","  ))"
"0","}"
