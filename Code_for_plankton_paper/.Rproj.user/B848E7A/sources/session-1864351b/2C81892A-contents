---
title: "MC_export"
author: "Anne Kruijt"
date: "2025-03-11"
output: html_document
---
# Script written with help of AI, but checked by author


# FUNCTION USED

```{r}


# Monte Carlo function for calculating F_exp
monte_carlo_F_exp <- function(C_exp_small, C_exp_large, C_uncertainty_fraction, Vs_low_small, Vs_high_small, Vs_low_large, Vs_high_large, n_simulations = 100000, confidence_level = 0.95) {
  
  # Ensure C_exp is valid
  if (is.na(C_exp_small) || is.na(C_exp_large)) {
    stop("Error: C_exp values contain NA. Please check input data.")
  }
  
  C_uncertainty_small <- C_uncertainty_fraction * C_exp_small
  C_uncertainty_large <- C_uncertainty_fraction * C_exp_large
  
  # Generate random samples for C_exp
  C_samples_small <- if (C_uncertainty_small > 0) {
    rnorm(n_simulations, mean = C_exp_small, sd = C_uncertainty_small)
  } else {
    rep(C_exp_small, n_simulations)
  }
  
  C_samples_large <- if (C_uncertainty_large > 0) {
    rnorm(n_simulations, mean = C_exp_large, sd = C_uncertainty_large)
  } else {
    rep(C_exp_large, n_simulations)
  }

  # Generate random samples for Vs using a uniform distribution
  Vs_samples_small <- runif(n_simulations, min = Vs_low_small, max = Vs_high_small)
  Vs_samples_large <- runif(n_simulations, min = Vs_low_large, max = Vs_high_large)
  
  # Compute F_exp: F_exp = C_exp * Vs
  F_exp_samples_small <- C_samples_small * Vs_samples_small
  F_exp_samples_large <- C_samples_large * Vs_samples_large

  # Total F_exp
  F_exp_samples_total <- F_exp_samples_large + F_exp_samples_small
    
  # Compute statistics
  mean_F_exp <- mean(F_exp_samples_total)
  std_F_exp <- sd(F_exp_samples_total)

  # Compute Confidence Interval
  z_value <- qnorm(1 - (1 - confidence_level) / 2)  # Z-score for confidence level
  error_margin <- z_value * (std_F_exp / sqrt(n_simulations))
  ci_lower <- mean_F_exp - error_margin
  ci_upper <- mean_F_exp + error_margin

  # Compute Percentiles (5th, 25th, 50th, 75th, 95th)
  percentiles <- quantile(F_exp_samples_total, probs = c(0.05, 0.25, 0.5, 0.75, 0.95))

  # Save results as a data frame
  results <- data.frame(
    F_exp_samples_total = F_exp_samples_total,
    ci_lower = ci_lower,
    ci_upper = ci_upper
  )

  # Print summary
  cat(sprintf("\nEstimated F_exp: %.6f units\n", mean_F_exp))
  cat(sprintf("Uncertainty (Standard Deviation): %.6f units\n", std_F_exp))
  cat(sprintf("%.0f%% Confidence Interval: [%.6f, %.6f] units\n", confidence_level * 100, ci_lower, ci_upper))
  cat("\nPercentiles:\n")
  print(percentiles)

  # Return results
  return(results)
}

```

# Loading data

```{r}

# Load required libraries
library(ggplot2)
library(readxl)

# Set seed for reproducibility
set.seed(123)


# Plankton data
C_exp_all <- read_xlsx("data_files_for_plotting/Cexp_for_MC_CALCULATIONS.xlsx")

```

```{r}

# Define target group
print("SET TARGET GROUP")
group <- 'foraminifera'
#group <- 'gastropod'

# Extract data for small and large stages
C_exp_st6_large <- C_exp_all$Cexp[C_exp_all$station == 6 & C_exp_all$group == group & C_exp_all$stage == 'large']
C_exp_st9_large <- C_exp_all$Cexp[C_exp_all$station == 9 & C_exp_all$group == group & C_exp_all$stage == 'large']
C_exp_avg_large <- (C_exp_st6_large + C_exp_st9_large) / 2  

C_exp_st6_small <- C_exp_all$Cexp[C_exp_all$station == 6 & C_exp_all$group == group & C_exp_all$stage == 'small']
C_exp_st9_small <- C_exp_all$Cexp[C_exp_all$station == 9 & C_exp_all$group == group & C_exp_all$stage == 'small']
C_exp_avg_small <- (C_exp_st6_small + C_exp_st9_small) / 2  

C_exp_coccosphere <-  C_exp_all$Cexp[C_exp_all$station == 6 & C_exp_all$group == 'coccosphere' & C_exp_all$stage == 'sphere']
C_exp_cocco_single <- C_exp_all$Cexp[C_exp_all$station == 6 & C_exp_all$group == 'coccolith' & C_exp_all$stage == 'single']
C_exp_cocco_pellet <- C_exp_all$Cexp[C_exp_all$station == 6 & C_exp_all$group == 'coccolith' & C_exp_all$stage == 'pellet']

# Define Vs values for each category (Fixed values)
Vs_low_g_l <- 1000   # Large gastropod (min estimate)
Vs_high_g_l <- 1900  # Large gastropod (max estimate)
Vs_low_g_s <- 450    # Small gastropod (min estimate)
Vs_high_g_s <- 1000  # Small gastropod (max estimate)

Vs_low_f_l <- 100   # Large foraminifera (min estimate)
Vs_high_f_l <- 500  # Large foraminifera (max estimate)
Vs_low_f_s <- 10   # Small foraminifera (min estimate)
Vs_high_f_s <- 200  # Small foraminifera (max estimate)

Vs_low_c_single <- 0.5   # coccolith single (minimum estimate)
Vs_high_c_single <- 1.6 # coccolith single (maximum estimate)

Vs_low_c_pellet <- 50   # coccolith pellet,  (minimum estimate)
Vs_high_c_pellet <- 225  # coccolith pellet (maximum estimate)

Vs_low_c_sphere <- 2   # coccosphere (minimum estimate)
Vs_high_c_sphere <- 6  # coccosphere (maximum estimate)




```


# SIMULATIONS
```{r}
if(group == 'gastropod'){
print('MC result gastropods')
# Run Monte Carlo Simulation for Gastropods
results_gastropods <- monte_carlo_F_exp(
  C_exp_small = C_exp_avg_small, 
  C_exp_large = C_exp_avg_large, 
  C_uncertainty = 0.25, 
  Vs_low_small = Vs_low_g_s, 
  Vs_high_small = Vs_high_g_s, 
  Vs_low_large = Vs_low_g_l, 
  Vs_high_large = Vs_high_g_l, 
  n_simulations = 100000, 
  confidence_level = 0.95
)
#write.csv(results_gastropods, "gastropods_F_exp_MC_results.csv", row.names = FALSE)
}

if(group == "foraminifera") {
  print("MC result foraminifera: ")

# Run Monte Carlo Simulation for Forams
results_forams <- monte_carlo_F_exp(
  C_exp_small = C_exp_avg_small,
  C_exp_large = C_exp_avg_large,
  C_uncertainty = 0.25,
  Vs_low_small = Vs_low_f_s,
  Vs_high_small = Vs_high_f_s,
  Vs_low_large = Vs_low_f_l,
  Vs_high_large = Vs_high_f_l,
  n_simulations = 100000,
  confidence_level = 0.95
)
#write.csv(results_forams, "forams_F_exp_MC_results.csv", row.names = FALSE)
} 

# Run Monte Carlo Simulation for Coccospheres

print("MC result coccospheres")
results_coccospheres <- monte_carlo_F_exp(
  C_exp_small = C_exp_coccosphere, 
  C_exp_large = 0,  # for coccospheres, we do not discriminate between large and small
  C_uncertainty = 0.25, 
  Vs_low_small = Vs_low_c_sphere, 
  Vs_high_small = Vs_high_c_sphere, 
  Vs_low_large = 0, 
  Vs_high_large = 0, 
  n_simulations = 100000, 
  confidence_level = 0.95
)

# Run Monte Carlo Simulation for Cocco_pellets
print("MC result coccos pellet")
results_cocco_pellet <- monte_carlo_F_exp(
  C_exp_small = C_exp_cocco_pellet, 
  C_exp_large = 0, # for coccoliths pellets, we do not discriminate between large and small
  C_uncertainty = 0.25, 
  Vs_low_small = Vs_low_c_pellet, 
  Vs_high_small = Vs_high_c_pellet, 
  Vs_low_large = 0, 
  Vs_high_large = 0, 
  n_simulations = 100000, 
  confidence_level = 0.95
)

# Run Monte Carlo Simulation for Cocco_single
print("MC result cocco single")
results_cocco_single <- monte_carlo_F_exp(
  C_exp_small = C_exp_cocco_single, 
  C_exp_large = 0, # for coccoliths single, we do not discriminate between large and small
  C_uncertainty = 0.25, 
  Vs_low_small = Vs_low_c_single, 
  Vs_high_small = Vs_high_c_single, 
  Vs_low_large = 0, 
  Vs_high_large = 0, 
  n_simulations = 100000, 
  confidence_level = 0.95
)


#write.csv(results_coccospheres, "coccospheres_F_exp_MC_results.csv", row.names = FALSE)

#write.csv(results_cocco_pellet, "cocco_pellet_F_exp_MC_results.csv", row.names = FALSE)

#write.csv(results_cocco_single, "cocco_single_F_exp_MC_results.csv", row.names = FALSE)

```

```{r}



# Plot histogram of results
p_1 <- ggplot(results_gastropods, aes(x = F_exp_samples_total)) +
  geom_histogram(bins = 50, fill = "steelblue", alpha = 0.7, color = "black") +
  geom_vline(xintercept = results_gastropods$ci_lower[1], color = "red", linetype = "dashed", linewidth = 1) +
  geom_vline(xintercept = results_gastropods$ci_upper[1], color = "red", linetype = "dashed", linewidth = 1) +
  labs(title = "F_exp distribution for gastropods",
       x = "F_exp (mg/m2/day)", y = "Frequency", size = 12) +
  theme_minimal()+
    theme(
    axis.title.y = element_text(size = 12),
    axis.title.x = element_blank()
  )


# Plot histogram of results
p_2 <- ggplot(results_forams, aes(x = F_exp_samples_total)) +
  geom_histogram(bins = 50, fill = "steelblue", alpha = 0.7, color = "black") +
  geom_vline(xintercept = results_forams$ci_lower[1], color = "red", linetype = "dashed", linewidth = 1) +
  geom_vline(xintercept = results_forams$ci_upper[1], color = "red", linetype = "dashed", linewidth = 1) +
  labs(title = "F_exp distribution for foraminifera",
       x = "F_exp (mg/m2/day)", y = "Frequency", size = 12) +
  theme_minimal()+
  theme(
    axis.title.y = element_blank(),
    axis.title.x = element_blank()
  )


# Plot histogram of results
p_3 <- ggplot(results_coccospheres, aes(x = F_exp_samples_total)) +
  geom_histogram(bins = 50, fill = "steelblue", alpha = 0.7, color = "black") +
  geom_vline(xintercept = results_coccospheres$ci_lower[1], color = "red", linetype = "dashed", linewidth = 1) +
  geom_vline(xintercept = results_coccospheres$ci_upper[1], color = "red", linetype = "dashed", linewidth = 1) +
  labs(title = "F_exp distribution for coccospheres",
       x = "F_exp (mg/m2/day)", y = "Frequency", size = 12) +
  theme_minimal()+
    theme(
    axis.title.y = element_text(size = 12),
    axis.title.x = element_blank()
  )


# Plot histogram of results
p_4 <- ggplot(results_cocco_pellet, aes(x = F_exp_samples_total)) +
  geom_histogram(bins = 50, fill = "steelblue", alpha = 0.7, color = "black") +
  geom_vline(xintercept = results_cocco_pellet$ci_lower[1], color = "red", linetype = "dashed", linewidth = 1) +
  geom_vline(xintercept = results_cocco_pellet$ci_upper[1], color = "red", linetype = "dashed", linewidth = 1) +
  labs(title = "F_exp distribution for cocco - pellets",
       x = "F_exp (mg/m2/day)", y = "Frequency", size = 12) +
  theme_minimal()+
    theme(
    axis.title.y = element_text(size = 12),
    axis.title.x = element_text(size = 12)
  )

# Plot histogram of results
p_5 <- ggplot(results_cocco_single, aes(x = F_exp_samples_total)) +
  geom_histogram(bins = 50, fill = "steelblue", alpha = 0.7, color = "black") +
  geom_vline(xintercept = results_cocco_single$ci_lower[1], color = "red", linetype = "dashed", linewidth = 1) +
  geom_vline(xintercept = results_cocco_single$ci_upper[1], color = "red", linetype = "dashed", linewidth = 1) +
  labs(title = "F_exp distribution for cocco - single",
       x = "F_exp (mg/m2/day)", y = "Frequency", size = 12) +
  theme_minimal()+
    theme(
    axis.title.y = element_text(size = 12),
    axis.title.x = element_text(size = 12)
  )

# Arrange plots
finalplot <- ggarrange(p_1, p_2, p_3, p_4, p_5,
          labels = c("A", "B", "C", "D", "E"),
          ncol = 2, nrow = 3,
          common.legend = TRUE, legend = "bottom") # Keep a common legend

ggsave("MC_Fexp_all.png", finalplot, width = 10, height = 12, dpi = 300)
# save to png or pdf
```
































