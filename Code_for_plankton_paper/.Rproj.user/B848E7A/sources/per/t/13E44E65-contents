---
title: "MC_turnover"
author: "Anne Kruijt"
date: "2025-03-13"
output: html_document
---

# Script written with help of AI, but checked by author


# FUNCTION USED

```{r}


# Monte Carlo function for calculating F_exp
monte_carlo_TT <- function(SS_small, SS_large, C_exp_small, C_exp_large, C_uncertainty_fraction, SS_uncertainty_fraction, Vs_low_small, Vs_high_small, Vs_low_large, Vs_high_large, n_simulations = 100000, confidence_level = 0.95) {
  
  # Ensure C_exp is valid
  if (is.na(C_exp_small) || is.na(C_exp_large)) {
    stop("Error: C_exp values contain NA. Please check input data.")
  }
  
  C_uncertainty_small <- C_uncertainty_fraction * C_exp_small
  C_uncertainty_large <- C_uncertainty_fraction * C_exp_large
  # Generate random samples for C_exp
  C_samples_small <- if (C_uncertainty_small > 0) {
    rnorm(n_simulations, mean = C_exp_small, sd = C_uncertainty_small)
  } else {
    rep(C_exp_small, n_simulations)
  }
  
  C_samples_large <- if (C_uncertainty_large > 0) {
    rnorm(n_simulations, mean = C_exp_large, sd = C_uncertainty_large)
  } else {
    rep(C_exp_large, n_simulations)
  }
  
  
  
  SS_uncertainty_small <- SS_uncertainty_fraction * SS_small
  SS_uncertainty_large <- SS_uncertainty_fraction * SS_large
  
  # Generate random samples for SS (Standing Stock)
  SS_samples_small <- if (SS_uncertainty_small > 0) {
    rnorm(n_simulations, mean = SS_small, sd = SS_uncertainty_small)
  } else {
    rep(SS_small, n_simulations)
  }

  
  # Generate random samples for SS (Standing Stock)
  SS_samples_large <- if (SS_uncertainty_large > 0) {
    rnorm(n_simulations, mean = SS_large, sd = SS_uncertainty_large)
  } else {
    rep(SS_large, n_simulations)
  }
  
  
  # Generate random samples for Vs using a uniform distribution
  Vs_samples_small <- runif(n_simulations, min = Vs_low_small, max = Vs_high_small)
  Vs_samples_large <- runif(n_simulations, min = Vs_low_large, max = Vs_high_large)
  
  # Compute F_exp: F_exp = C_exp * Vs
  F_exp_samples_small <- C_samples_small * Vs_samples_small
  F_exp_samples_large <- C_samples_large * Vs_samples_large

  # Total F_exp
  F_exp_samples_total <- F_exp_samples_large + F_exp_samples_small
  
  # TT 
  TT_samples_small <- SS_samples_small / F_exp_samples_small
  TT_samples_large <- SS_samples_large / F_exp_samples_large
  
    
  # Compute statistics
  mean_TT_small <- mean(TT_samples_small)
  std_TT_small <- sd(TT_samples_small)
  mean_TT_large <- mean(TT_samples_large)
  std_TT_large <- sd(TT_samples_large)  

  # Compute Confidence Interval
  z_value_s <- qnorm(1 - (1 - confidence_level) / 2)  # Z-score for confidence level
  error_margin <- z_value_s * (std_TT_small / sqrt(n_simulations))
  ci_lower_s <- mean_TT_small - error_margin
  ci_upper_s <- mean_TT_small + error_margin
  
  z_value_l <- qnorm(1 - (1 - confidence_level) / 2)  # Z-score for confidence level
  error_margin <- z_value_l * (std_TT_large / sqrt(n_simulations))
  ci_lower_l <- mean_TT_large - error_margin
  ci_upper_l <- mean_TT_large + error_margin  
  

  # Compute Percentiles (5th, 25th, 50th, 75th, 95th)
  percentiles_s <- quantile(TT_samples_small, probs = c(0.05, 0.25, 0.5, 0.75, 0.95))
  percentiles_l <- quantile(TT_samples_large, probs = c(0.05, 0.25, 0.5, 0.75, 0.95))
  
 

  # Save results as a data frame
  results <- data.frame(
    TT_samples_small = TT_samples_small,
    mean_TT_small = mean_TT_small,
    std_TT_small = std_TT_small,
    ci_lower_s = ci_lower_s,
    ci_upper_s = ci_upper_s,
    TT_samples_large = TT_samples_large,
    mean_TT_large = mean_TT_large,
    std_TT_large = std_TT_large,
    ci_lower_l = ci_lower_l,
    ci_upper_l = ci_upper_l
    
   )
  # 
  # # Print summary
  # cat(sprintf("\nEstimated F_exp: %.6f units\n", mean_TT_small))
  # cat(sprintf("Uncertainty (Standard Deviation): %.6f units\n", std_TT_small))
  # cat(sprintf("%.0f%% Confidence Interval: [%.6f, %.6f] units\n", confidence_level * 100, ci_lower, ci_upper))
  # cat("\nPercentiles:\n")
  # print(percentiles)

  # Return results
  return(results)
}

```






```{r}

# Load required libraries
library(ggplot2)
library(readxl)

# Set seed for reproducibility
set.seed(123)


C_exp_all <- read_xlsx("data_files_for_plotting/Cexp_for_MC_CALCULATIONS.xlsx") 
SS_all <- read_xlsx("data_files_for_plotting/Standingstocks_for_MC_CALCULATIONS.xlsx")


# Extract SS data
SS_st6_gastro_s <- SS_all$`SSm2 [mg/m2]`[SS_all$station == 6 & SS_all$group == "gastropod juvenile"]
SS_st9_gastro_s <- SS_all$`SSm2 [mg/m2]`[SS_all$station == 9 & SS_all$group == "gastropod juvenile"]
SS_av_gastro_s <- (SS_st6_gastro_s + SS_st9_gastro_s )/2
SS_st6_gastro_l <- SS_all$`SSm2 [mg/m2]`[SS_all$station == 6 & SS_all$group == "gastropod adult"]
SS_st9_gastro_l <- SS_all$`SSm2 [mg/m2]`[SS_all$station == 9 & SS_all$group == "gastropod adult"]
SS_av_gastro_l <- (SS_st6_gastro_l + SS_st9_gastro_l )/2
SS_st6_foram_s <- SS_all$`SSm2 [mg/m2]`[SS_all$station == 6 & SS_all$group == "foraminifera 100-200 um"]
SS_st9_foram_s <- SS_all$`SSm2 [mg/m2]`[SS_all$station == 9 & SS_all$group == "foraminifera 100-200 um"]
SS_av_foram_s <- (SS_st6_foram_s + SS_st9_foram_s )/2
SS_st6_foram_l <- SS_all$`SSm2 [mg/m2]`[SS_all$station == 6 & SS_all$group == "foraminifera > 200um"]
SS_st9_foram_l <- SS_all$`SSm2 [mg/m2]`[SS_all$station == 9 & SS_all$group == "foraminifera > 200um"]
SS_av_foram_l <- (SS_st6_foram_l + SS_st9_foram_l )/2


# Define target group
print("SET TARGET GROUP")
#group <- 'foraminifera'
group <- 'gastropod'

# Extract data for small and large stages
C_exp_st6_large <- C_exp_all$Cexp[C_exp_all$station == 6 & C_exp_all$group == group & C_exp_all$stage == 'large']
C_exp_st9_large <- C_exp_all$Cexp[C_exp_all$station == 9 & C_exp_all$group == group & C_exp_all$stage == 'large']
C_exp_avg_large <- (C_exp_st6_large + C_exp_st9_large) / 2  

C_exp_st6_small <- C_exp_all$Cexp[C_exp_all$station == 6 & C_exp_all$group == group & C_exp_all$stage == 'small']
C_exp_st9_small <- C_exp_all$Cexp[C_exp_all$station == 9 & C_exp_all$group == group & C_exp_all$stage == 'small']
C_exp_avg_small <- (C_exp_st6_small + C_exp_st9_small) / 2  


# Define Vs values for each category (Fixed values)
Vs_low_g_l <- 1000   # Large gastropod (min estimate)
Vs_high_g_l <- 1900  # Large gastropod (max estimate)
Vs_low_g_s <- 450    # Small gastropod (min estimate)
Vs_high_g_s <- 1000  # Small gastropod (max estimate)

Vs_low_f_l <- 100   # Large foraminifera (min estimate)
Vs_high_f_l <- 500  # Large foraminifera (max estimate)
Vs_low_f_s <- 10   # Small foraminifera (min estimate)
Vs_high_f_s <- 200  # Small foraminifera (max estimate)



```


# SIMULATIONS
```{r}
if(group =="gastropod"){

# Run Monte Carlo Simulation for Gastropods
results_gastropods <- monte_carlo_TT( 
  SS_av_gastro_s,
  SS_av_gastro_l,
  C_exp_small = C_exp_avg_small, 
  C_exp_large = C_exp_avg_large, 
  C_uncertainty_fraction = 0.25, 
  SS_uncertainty_fraction = 0.25,
  Vs_low_small = Vs_low_g_s, 
  Vs_high_small = Vs_high_g_s, 
  Vs_low_large = Vs_low_g_l, 
  Vs_high_large = Vs_high_g_l, 
  n_simulations = 100000, 
  confidence_level = 0.95
)
}

if(group =="foraminifera"){
# Run Monte Carlo Simulation for Forams
results_forams <- monte_carlo_TT(
  SS_av_foram_s,
  SS_av_foram_l,
  C_exp_small = C_exp_avg_small,
  C_exp_large = C_exp_avg_large,
  C_uncertainty_fraction = 0.25,
  SS_uncertainty_fraction = 0.25,
  Vs_low_small = Vs_low_f_s,
  Vs_high_small = Vs_high_f_s,
  Vs_low_large = Vs_low_f_l,
  Vs_high_large = Vs_high_f_l,
  n_simulations = 100000,
  confidence_level = 0.95
)
}

```

```{r}
# Save results
#write.csv(results_gastropods, "gastropods_TT_MC_results.csv", row.names = FALSE)

#write.csv(results_forams, "forams_TT_MC_results.csv", row.names = FALSE)

```
