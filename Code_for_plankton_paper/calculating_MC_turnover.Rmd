---
title: "MC_turnover"
author: "Anne Kruijt"
date: "2025-03-13"
output: html_document
---

# Script written with help of AI, but checked by author


# FUNCTION USED

```{r}
# Corrected Monte Carlo Function with Safe C_exp Sampling and Plotting Sanity Checks

monte_carlo_TT <- function(
  SS_small, SS_large,
  C_exp_small, C_exp_large,
  C_uncertainty_fraction, SS_uncertainty_fraction,
  Vs_low_small, Vs_high_small, Vs_low_large, Vs_high_large,
  n_simulations = 100000, confidence_level = 0.95
) {

  # Stop if C_exp is missing
  if (is.na(C_exp_small) || is.na(C_exp_large)) {
    stop("Error: C_exp values contain NA. Please check input data.")
  }

  # Compute absolute uncertainty from fraction for C_exp
  C_uncertainty_small <- C_uncertainty_fraction * C_exp_small
  C_uncertainty_large <- C_uncertainty_fraction * C_exp_large

  # Sample C_exp, ensure non-negative values using pmax
  C_samples_small <- if (C_uncertainty_small > 0) {
    pmax(rnorm(n_simulations, mean = C_exp_small, sd = C_uncertainty_small), 0)
  } else {
    rep(C_exp_small, n_simulations)
  }

  C_samples_large <- if (C_uncertainty_large > 0) {
    pmax(rnorm(n_simulations, mean = C_exp_large, sd = C_uncertainty_large), 0)
  } else {
    rep(C_exp_large, n_simulations)
  }

  # Compute absolute uncertainty for SS
  SS_uncertainty_small <- SS_uncertainty_fraction * SS_small
  SS_uncertainty_large <- SS_uncertainty_fraction * SS_large

  # Sample SS with rnorm
  SS_samples_small <- if (SS_uncertainty_small > 0) {
    pmax(rnorm(n_simulations, mean = SS_small, sd = SS_uncertainty_small), 0)
  } else {
    rep(SS_small, n_simulations)
  }

  SS_samples_large <- if (SS_uncertainty_large > 0) {
    pmax(rnorm(n_simulations, mean = SS_large, sd = SS_uncertainty_large), 0)
  } else {
    rep(SS_large, n_simulations)
  }

  # Sample Vs from uniform distribution
  Vs_samples_small <- runif(n_simulations, min = Vs_low_small, max = Vs_high_small)
  Vs_samples_large <- runif(n_simulations, min = Vs_low_large, max = Vs_high_large)

  # Compute F_exp = C_exp * Vs
  F_exp_samples_small <- C_samples_small * Vs_samples_small
  F_exp_samples_large <- C_samples_large * Vs_samples_large

  # Compute turnover time TT = SS / F_exp
  TT_samples_small <- SS_samples_small / F_exp_samples_small
  TT_samples_large <- SS_samples_large / F_exp_samples_large

  # Clean samples: remove NaN, Inf, negative, or zero
  TT_samples_small <- TT_samples_small[is.finite(TT_samples_small) & TT_samples_small > 0]
  TT_samples_large <- TT_samples_large[is.finite(TT_samples_large) & TT_samples_large > 0]

  # Compute mean and standard deviation
  mean_TT_small <- mean(TT_samples_small)
  std_TT_small <- sd(TT_samples_small)
  mean_TT_large <- mean(TT_samples_large)
  std_TT_large <- sd(TT_samples_large)

  # Confidence intervals for small stage
  z_s <- qnorm(1 - (1 - confidence_level) / 2)
  error_s <- z_s * (std_TT_small / sqrt(length(TT_samples_small)))
  ci_lower_s <- mean_TT_small - error_s
  ci_upper_s <- mean_TT_small + error_s

  # Confidence intervals for large stage
  z_l <- qnorm(1 - (1 - confidence_level) / 2)
  error_l <- z_l * (std_TT_large / sqrt(length(TT_samples_large)))
  ci_lower_l <- mean_TT_large - error_l
  ci_upper_l <- mean_TT_large + error_l

  # Return results as data frame
  return(list(
    TT_samples_small = TT_samples_small,
    mean_TT_small = mean_TT_small,
    std_TT_small = std_TT_small,
    ci_lower_s = ci_lower_s,
    ci_upper_s = ci_upper_s,
    TT_samples_large = TT_samples_large,
    mean_TT_large = mean_TT_large,
    std_TT_large = std_TT_large,
    ci_lower_l = ci_lower_l,
    ci_upper_l = ci_upper_l
  ))
}
```


```{r}

# Load required libraries
library(ggplot2)
library(readxl)

# Set seed for reproducibility
set.seed(123)


C_exp_all <- read_xlsx("data_files_for_plotting/Cexp_for_MC_CALCULATIONS.xlsx") 
SS_all <- read_xlsx("data_files_for_plotting/Standingstocks_for_MC_CALCULATIONS.xlsx")


# Extract SS data
SS_st6_gastro_s <- SS_all$`SSm2 [mg/m2]`[SS_all$station == 6 & SS_all$group == "gastropod juvenile"]
SS_st9_gastro_s <- SS_all$`SSm2 [mg/m2]`[SS_all$station == 9 & SS_all$group == "gastropod juvenile"]
SS_av_gastro_s <- (SS_st6_gastro_s + SS_st9_gastro_s )/2
SS_st6_gastro_l <- SS_all$`SSm2 [mg/m2]`[SS_all$station == 6 & SS_all$group == "gastropod adult"]
SS_st9_gastro_l <- SS_all$`SSm2 [mg/m2]`[SS_all$station == 9 & SS_all$group == "gastropod adult"]
SS_av_gastro_l <- (SS_st6_gastro_l + SS_st9_gastro_l )/2
SS_st6_foram_s <- SS_all$`SSm2 [mg/m2]`[SS_all$station == 6 & SS_all$group == "foraminifera 100-200 um"]
SS_st9_foram_s <- SS_all$`SSm2 [mg/m2]`[SS_all$station == 9 & SS_all$group == "foraminifera 100-200 um"]
SS_av_foram_s <- (SS_st6_foram_s + SS_st9_foram_s )/2
SS_st6_foram_l <- SS_all$`SSm2 [mg/m2]`[SS_all$station == 6 & SS_all$group == "foraminifera > 200um"]
SS_st9_foram_l <- SS_all$`SSm2 [mg/m2]`[SS_all$station == 9 & SS_all$group == "foraminifera > 200um"]
SS_av_foram_l <- (SS_st6_foram_l + SS_st9_foram_l )/2


# Define target group
print("SET TARGET GROUP")
group <- 'foraminifera'
#group <- 'gastropod'

# Extract data for small and large stages
C_exp_st6_large <- C_exp_all$Cexp[C_exp_all$station == 6 & C_exp_all$group == group & C_exp_all$stage == 'large']
C_exp_st9_large <- C_exp_all$Cexp[C_exp_all$station == 9 & C_exp_all$group == group & C_exp_all$stage == 'large']
C_exp_avg_large <- (C_exp_st6_large + C_exp_st9_large) / 2  

C_exp_st6_small <- C_exp_all$Cexp[C_exp_all$station == 6 & C_exp_all$group == group & C_exp_all$stage == 'small']
C_exp_st9_small <- C_exp_all$Cexp[C_exp_all$station == 9 & C_exp_all$group == group & C_exp_all$stage == 'small']
C_exp_avg_small <- (C_exp_st6_small + C_exp_st9_small) / 2  


# Define Vs values for each category (Fixed values)
Vs_low_g_l <- 1000   # Large gastropod (min estimate)
Vs_high_g_l <- 1900  # Large gastropod (max estimate)
Vs_low_g_s <- 450    # Small gastropod (min estimate)
Vs_high_g_s <- 1000  # Small gastropod (max estimate)

Vs_low_f_l <- 100   # Large foraminifera (min estimate)
Vs_high_f_l <- 500  # Large foraminifera (max estimate)
Vs_low_f_s <- 10   # Small foraminifera (min estimate)
Vs_high_f_s <- 200  # Small foraminifera (max estimate)



```


# SIMULATIONS
```{r}
if(group =="gastropod"){

# Run Monte Carlo Simulation for Gastropods
results_gastropods <- monte_carlo_TT( 
  SS_av_gastro_s,
  SS_av_gastro_l,
  C_exp_small = C_exp_avg_small, 
  C_exp_large = C_exp_avg_large, 
  C_uncertainty_fraction = 0.25, 
  SS_uncertainty_fraction = 0.25,
  Vs_low_small = Vs_low_g_s, 
  Vs_high_small = Vs_high_g_s, 
  Vs_low_large = Vs_low_g_l, 
  Vs_high_large = Vs_high_g_l, 
  n_simulations = 100000, 
  confidence_level = 0.95
)
}

if(group =="foraminifera"){
# Run Monte Carlo Simulation for Forams
results_forams <- monte_carlo_TT(
  SS_av_foram_s,
  SS_av_foram_l,
  C_exp_small = C_exp_avg_small,
  C_exp_large = C_exp_avg_large,
  C_uncertainty_fraction = 0.25,
  SS_uncertainty_fraction = 0.25,
  Vs_low_small = Vs_low_f_s,
  Vs_high_small = Vs_high_f_s,
  Vs_low_large = Vs_low_f_l,
  Vs_high_large = Vs_high_f_l,
  n_simulations = 100000,
  confidence_level = 0.95
)
}
```


#Plotting all results together
```{r}

ttresult <- results_gastropods$TT_samples_small
ci_l <- results_gastropods$ci_lower_s
ci_u <- results_gastropods$ci_upper_s


summary(ttresult)


# Plot histogram of turnover results with CI lines
p_gastro_tt_s <- ggplot(data.frame(ttresult), aes(x = ttresult)) +
  geom_histogram(bins = 50, fill = "steelblue", alpha = 0.7, color = "black") +
  geom_vline(xintercept = ci_l, color = "red", linetype = "dashed", linewidth = 1) +
  geom_vline(xintercept = ci_u, color = "red", linetype = "dashed", linewidth = 1) +
  labs(title = "Turnover distribution juvenile gastropods ",
       x = "Turnover time [day]", y = "Frequency") +
  theme_minimal()+
  theme(
    axis.title.y = element_text(size = 12),
    axis.title.x = element_blank()
  )


ttresult <- results_gastropods$TT_samples_large
ci_l <- results_gastropods$ci_lower_l
ci_u <- results_gastropods$ci_upper_l




# Plot histogram of turnover results with CI lines
p_gastro_tt_l <- ggplot(data.frame(ttresult), aes(x = ttresult)) +
  geom_histogram(bins = 50, fill = "steelblue", alpha = 0.7, color = "black") +
  geom_vline(xintercept = ci_l, color = "red", linetype = "dashed", linewidth = 1) +
  geom_vline(xintercept = ci_u, color = "red", linetype = "dashed", linewidth = 1) +
  labs(title = "Turnover distribution adult gastropods ",
       x = "Turnover time [day]", y = "Frequency") +
  theme_minimal()+
  theme(
    axis.title.y = element_blank(),
    axis.title.x = element_blank()
  )



ttresult <- results_forams$TT_samples_small
ci_l <- results_forams$ci_lower_s
ci_u <- results_forams$ci_upper_s
# Plot histogram of turnover results with CI lines
p_foram_tt_s <- ggplot(data.frame(ttresult), aes(x = ttresult)) +
  geom_histogram(bins = 50, fill = "steelblue", alpha = 0.7, color = "black") +
  geom_vline(xintercept = ci_l, color = "red", linetype = "dashed", linewidth = 1) +
  geom_vline(xintercept = ci_u, color = "red", linetype = "dashed", linewidth = 1) +
  labs(title = "Turnover distribution small foraminifera ",
       x = "Turnover time [days]", y = "Frequency") +
  theme_minimal()+
  theme(
    axis.title.y = element_text(size = 12) , 
    axis.title.x = element_text(size = 12)
  )


ttresult <- results_forams$TT_samples_large
ci_l <- results_forams$ci_lower_l
ci_u <- results_forams$ci_upper_l
# Plot histogram of turnover results with CI lines
p_foram_tt_l <- ggplot(data.frame(ttresult), aes(x = ttresult)) +
  geom_histogram(bins = 50, fill = "steelblue", alpha = 0.7, color = "black") +
  geom_vline(xintercept = ci_l, color = "red", linetype = "dashed", linewidth = 1) +
  geom_vline(xintercept = ci_u, color = "red", linetype = "dashed", linewidth = 1) +
  labs(title = "Turnover distribution large foraminifera ",
       x = "Turnover time [days]", y = "Frequency") +
  theme_minimal()+
  theme(
    axis.title.y = element_blank(),
    axis.title.x = element_text(size = 12)
  )






# Arrange plots
finalplot <- ggarrange(p_gastro_tt_s,p_gastro_tt_l, p_foram_tt_s, p_foram_tt_l,
          labels = c("a", "b","c", "d"),
          ncol = 2, nrow = 2,
          common.legend = TRUE, legend = "bottom") # Keep a common legend

ggsave("MC_tt_all.png", finalplot, width = 10, height = 10, dpi = 300)





```





```